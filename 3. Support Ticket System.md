**Support Ticket System**

We will learn about Laravel main features, such as Eloquent ORM, Eloquent Relationships, Migrations, Requests, Laravel Collective, sending emails, etc. by developing this cool ticket system

Our ticket system is simple:
- When users visit the contact page, they will be able to submit a ticket to contact us.
- Once they've created a ticket, the system will send us an email to let us know that there is a new ticket.
- The ticket system automatically generates a unique link to let us access the ticket.
- We can view all the tickets.
- We can be able to reply, edit, change tickets' status or delete them.

Let's start building things!


Our application requires a database to work. Laravel supports many database platforms, including:
- MySQL
- SQLite
- PostgreSQL
- SQL Server
- MariaDB


You can configure databases using database.php file, which is placed in the config directory.

If you use Homestead, Laravel has created a homestead database for you already. If you don't use Homestead, you will need to create a database manually.

Laravel usesï¿½PHP Data Objects (PDO). When we execute a Laravel SQL query, rows are returned in a form of a stdClass object. For instance, we may access our data using:
```
		$user->name		
```

**Setup the DB config**

Db setting located at config/database.php
```
'mysql' => [
            'driver' => 'mysql',
            'host' => env('DB_HOST', '127.0.0.1'),
            'port' => env('DB_PORT', '3306'),
            'database' => env('DB_DATABASE', 'forge'),
            'username' => env('DB_USERNAME', 'forge'),
            'password' => env('DB_PASSWORD', ''),
            'unix_socket' => env('DB_SOCKET', ''),
            'charset' => 'utf8mb4',
            'collation' => 'utf8mb4_unicode_ci',
            'prefix' => '',
            'strict' => false, 
],
```

**Setup the .env file**

Think of this as a single secure place that we can use to store everything from password, keys, API keys, paths and anything.

This file is basically is for your local environment. So other teammates can use the setting and different environment.
```
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=ticketsupport
DB_USERNAME=root
DB_PASSWORD=
```

**Using Migrations**

One of the best features of Laravel is Migrations.

Whether you're working with a team or alone, you may need to find a way to keep track your database schema. Laravel Migrations is the right way to go.

Laravel uses migration files to know what we change in our database. The great thing is, you can easily revert or apply changes to your applications by just running a command. For example, we can use this command to reset the database:
```
			php artisan migrate:reset
```

**Create a new migration file**

Now, let's try to generate a new migration file!

We're going to create a tickets table. Go to your application root, execute this command:
```
		php artisan make:migration create_tickets_table
```

You'll see:
```
		Created Migration: 2017_08_14_193947_create_tickets_table
```

But... WAIT!

We have a faster way to create the tickets table: using --create option.

Delete the migration file that you've just created. Once deleted, run this command:
```
		php artisan make:migration create_tickets_table --create=tickets
```

By using the --create option, Laravel automatically generates the codes to create the tickets table for you.
```
public function up()
{
    Schema::create('tickets', function (Blueprint $table) {
        $table->increments('id');
        $table->timestamps();
    });
}
```
If you see this error:

```
[ErrorException]  include(/home/vagrant/Code/Laravel/database/migrations/2016_09_09_193947_create_tickets_table.php): failed to open stream: No such file or directory
```

You will need to run this command to regenerate the list of all classes that need to be included in your app:
```
			composer dump-autoload -o
```
If you see this error:
```
[Illuminate\Database\QueryException] SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long;
```
You may be running a version of MySQL older than the 5.7.7 release. 
To fix the bug, you need to edit the AppServiceProvider.php file, and set a default string length inside the boot method:

```
use Illuminate\Support\Facades\Schema;

public function boot()
{
    Schema::defaultStringLength(191);
}
```

Our tickets will have these columns:
- id
- title
- content
- slug: URL friendly version of the ticket title
- status: current status of the ticket (answered or pending)
- user_id: who created the ticket

Modiy create_tickets_table to following
```
<?php
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;
class CreateTicketsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('tickets', function (Blueprint $table) {
            $table->increments('id');
            $table->string('title', 255);
            $table->text('content');
            $table->string('slug')->nullable();
            $table->tinyInteger('status')->default(1);
            $table->integer('user_id')->nullable();
            $table->timestamps();
        });
    }
    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('tickets');
    }
}
```

Finally, run this command to create the tickets table and its columns:
```
		php artisan migrate
```

Well, I guess it worked! It looks like the tables have been created. Let's check the mysql database:


**Eloquent model**

Eloquent provides a simple way to use ActiveRecord pattern when working with databases. By using this technique, we can wrap our database into objects.

What does it mean?

In Object Oriented Programming (OOP), we usually create multiple objects. Objects can be anything that has properties and actions. For example, a mobile phone can be an object. Each model of a phone has its own blueprint. You can buy a new case for your phone, or you can change its home screen. But no matter you customize it, it's still based on the blueprint that was created by the manufacturer.

We call that blueprint: MODEL.

Basically, model's just a class. Each model has its own variables (features of each mobile phone) and methods (actions that you take to customize the phone).

Model is known as the M in the MVC system (Model-View-Controller).


To get started, let's create our first Ticket model by running this Artisan command:
```
		php artisan make:model Ticket
```

You can find the Ticket model (Ticket.php) in the app directory.

Ok, let's open our new Ticket model:

As you may notice, the Ticket model is just a PHP class that extends the Model class. Now we can use this file to tell Laravel about its relationships. For instance, each ticket is created by a user, we can tell tickets belongs to users by writing like this:
```
public function user()
{
    return $this->belongsTo('App\User');
}
```

We also can be able to use this model to access any tickets' data, such as: title, content, etc.

```
public function getTitle()
{
    return $this->title
}
```

For some reasons, if you want to use a different name, you can let Eloquent know that by defining a table property like this:
```
		protected $table = 'yourCustomTableName';
```

Read more about Eloquent here:
	http://laravel.com/docs/master/eloquent

**Create a page to submit tickets**

To create a new ticket, we will need to use Controller action (also known as Controller method) and view to display the new ticket form.

Go to our views directory, create a new directory called tickets.

Next, create a new Blade template called create.blade.php in that directory. And add following code.
```
@extends('layouts.master')
@section('title', 'Contact')

@section('content')
    <div class="container col-md-8 col-md-offset-2">
        <div class="well well bs-component">
            <form class="form-horizontal">
                <fieldset>
                    <legend>Submit a new ticket</legend>
                    <div class="form-group">
                        <label for="title" class="col-lg-2 control-label">Title</label>
                        <div class="col-lg-10">
                            <input type="text" class="form-control" id="title" placeholder="Title">
                        </div>
                    </div>
 <div class="form-group">
                        <label for="content" class="col-lg-2 control-label">Content</label>

<div class="col-lg-10">
                            <textarea class="form-control" rows="3" id="content"></textarea>
                            <span class="help-block">Feel free to ask us any question.</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
```

**Controller**

Open PagesController.php, edit:
```
public function contact()
{
    return view('tickets.create');
}
```

**Create a new controller for the tickets**

TicketsController will be responsible for creating, editing and deleting tickets. It will help to organize and maintain our application much easier.

You have known how to create a controller, let's create the TicketsController by running this command:
```
		php artisan make:controller TicketsController  resource
```

Note : As mentioned before, by using the --resource flag, Laravel creates some RESTful actions (create, edit, update, etc.) for us.

Update the create action as follows:
```
public function create()
{
    return view('tickets.create');
}
```

And don't forget to update the web.php file:
```
		Route::get('/contact', 'TicketsController@create');
```

**Introducing HTTP Requests**

Luckily, Laravel 5 has a new feature called Requests (aka HTTP Requests or Form Requests).

When users send a request (submit a ticket, for example), we can use the new Request class to define some rules and validate the request.

If the validator passes, then everything will be executed as normal. Otherwise, the user will be automatically redirected back to where they are.


We will use Request to validate the create ticket form.

To create a new Request, simply run this Artisan command:
```
		php artisan make:request TicketFormRequest
```

A new TicketFormRequest will be generated! You can find it in the app/Http/Requests directory.

Open the file, you can see that there are two methods: authorize and rules.
```
authorize()
```

By default, it returns false. That means no one can be able to perform the request. To be able to submit the tickets, we have to turn it to true
```
rules()
```

We use this method to define our validation rules.

Currently, our create ticket form has two fields: title and content, we can set the following rules:
```
public function rules()
{
    return [
        'title' => 'required|min:3',
        'content'=> 'required|min:10',
    ];
}
```
**Laravel Collective packages**

Since Laravel 5, some Laravel components have been removed from the core framework. If you've used older versions of Laravel before, you may love these features:

- HTML: HTML helpers for creating common HTML and form elements
- Annotations: route and events annotations.
- Remote: a simple way to SSH into remote servers and run commands.

Fortunately, bringing all these features back is very easy. You just need to install LaravelCollective package!

	https://laravelcollective.com

To install a Laravel package using Composer, you just need to add the following code:

Add "laravelcollective/html": "5.4.*" in require array:
```
"require": {
    .......
    "laravelcollective/html": "5.4.*"
},
```

Save the file and run this command at your application root:
```
			composer update
```

Alternatively, you can run this command :
```
composer require laravelcollective/html
```
**Create a service provider and aliases**

After installing the HTML package via Composer. You need to follow some extra steps to let Laravel know where to find the package and use it.

To use the package, you have to add a service provider to the providers array of the config/app.php.


Add the following line to the $provider array:
```
		Collective\Html\HtmlServiceProvider::class,
```

And add these two aliases to the aliases array:
```
 'Form' => Collective\Html\FormFacade::class,
  'Html' => Collective\Html\HtmlFacade::class,
```

How to use HTML packageThe HTML package helps us to build forms easier and faster. 

Normal HTML code:
```
        <form action="contact">
            <label>First name:</label>
            <input type="text" name="firstname" value="Enter your first name">
            <br />
            <label>Last name:</label>
            <input type="text" name="lastname" value="Enter your last name">
            <br />
            <input type="submit" value="Submit">
        </form>
```
Using HTML package:
```
        {!! Form::open(array ('url' => 'contact')) !!}
        {!! Form::label('First name') !!}
        {!! Form::text('firstname', 'Enter your first name') !!}
        <br />
        {!! Form::label('Last name') !!}
        {!! Form::text('lastname', 'Enter your last name') !!}
        <br />
        {!! Form::submit() !!}
        {!! Form::close() !!}
```

**Submit the form data**

We use get to display form.
```
		Route::get('/contact', 'TicketsController@create');
```

We will use post to retrieve data from form submission. Add this in routes/web.php
```
		Route::post('/contact', 'TicketsController@store');
```

The store action in TicketController is still empty. You can update it to display the form data:
```
public function store(TicketFormRequest $request)
{
    return $request->all();
}
````

Add this line at the of the TicketsController.php file:
```
		use App\Http\Requests\TicketFormRequest;
```

One more step, you need to update the ticket form to send POST requests. Open tickets/create.blade.php.

Update this line of code :
```
		<form class="form-horizontal" method="post">
```

Also assign name for each form fields.

**Oops! There is an error.**

What is **TokenMismatchException**?

For security purposes, Laravel requires a token to be sent when using the POST method. If you don't send any token, it will throw an error.

To fix this, you need to add a hidden token field below your form opening tag:
```
<form class="form-horizontal" method="post">
    <input type="hidden" name="_token" value="{!! csrf_token() !!}">
```

**Error display**

One last step is to display the errors when the users don't fill the form or the form is not valid.

Find:
```
		<form class="form-horizontal" method="post">
```

add below:
```
@foreach ($errors->all() as $error)
    <p class="alert alert-danger">{{ $error }}</p>
@endforeach
```

Basically, if the validator fails, Laravel will store all errors in the session. We can easily access the errors via $errors object.

Now, let's go back to the form, don't fill anything and hit the submit button:


Here is the new tickets/create.blade.php file:
```
@extends('master')
@section('title', 'Create a new ticket')

@section('content')
    <div class="container col-md-8 col-md-offset-2">
        <div class="well well bs-component">

            <form class="form-horizontal" method="post">

                @foreach ($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach

                <input type="hidden" name="_token" value="{!! csrf_token() !!}">

                <fieldset>
                    <legend>Submit a new ticket</legend>
                    <div class="form-group">
                        <label for="title" class="col-lg-2 control-label">Title</label>
                        <div class="col-lg-10">
                            <input type="text" class="form-control" id="title" placeholder="Title" name="title">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="content" class="col-lg-2 control-label">Content</label>
                        <div class="col-lg-10">
                            <textarea class="form-control" rows="3" id="content" name="content"></textarea>
                            <span class="help-block">Feel free to ask us any question.</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
````

**Insert data into the database**

Once you have the submitted form data, inserting the data into the database is pretty easy.

First, let's begin by putting this line at the top of your TicketsController file:
```
		use App\Ticket;
```

Be sure to put it above the class name.

Now you can use Ticket model to store the form data. Update the store action as follows:
```
public function store(TicketFormRequest $request)
{
    $slug = uniqid();
    $ticket = new Ticket(array(
        'title' => $request->get('title'),
        'content' => $request->get('content'),
        'slug' => $slug
    ));

    $ticket->save();
    return redirect('/contact')->with('status', 'Your ticket has been created! Its unique id is: '.$slug);
}
```

**Oh no!**
```
There is an error: "MassAssignmentException"
```

Don't worry, it's a Laravel feature that protect against mass-assignment.

What is mass-assignment?

According to the Laravel official docs:
```
"mass-assignment vulnerability occurs when user's pass unexpected HTTP parameters through a request,
and then that parameter changes a column in your database you did not expect. For example, a malicious
user might send an is_admin parameter through an HTTP request, which is then mapped onto your model's
create method, allowing the user to escalate themselves to an administrator"
```
Read more about it here:

	https://laravel.com/docs/master/eloquent#mass-assignment

	
To save the ticket, open the Ticket model. (Ticket.php file)

Then place the following contents into the Ticket Model:
```
class Ticket extends Model
{
    protected $fillable = ['title', 'content', 'slug', 'status', 'user_id'];
}
```

The $fillable property make the columns mass assignable.

One more thing to do, we need to update the tickets/create.blade.php view to display the status message:
Find:
```
<form class="form-horizontal" method="post">
    @foreach ($errors->all() as $error)
        <p class="alert alert-danger">{{ $error }}</p>
    @endforeach
```
Add below it:
```
@if (session('status'))
    <div class="alert alert-success">
        {{ session('status') }}
    </div>
@endif
```

Good! Try to create a new ticket again.	

**View all tickets**

As you continue developing the app, you'll find that you need a way to display all tickets, so you can be able to view, modify or delete them easily.

The following are the steps to list all tickets:

First, we'll modify the web.php file:
```
		Route::get('/tickets', 'TicketsController@index');	
```

Then, open the TicketsController file, and update the index action:
```
public function index()
{
    $tickets = Ticket::all();
    return view('tickets.index', compact('tickets'));
}
```

Finally, create a new view called index.blade.php and place it in the tickets directory:
```
@extends('master')
@section('title', 'View all tickets')
@section('content')

    <div class="container col-md-8 col-md-offset-2">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h2> Tickets </h2>
                </div>
                @if ($tickets->isEmpty())
                    <p> There is no ticket.</p>
                @else
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Status</th>

                            </tr>
                        </thead>
                        <tbody>
                            @foreach($tickets as $ticket)
                                <tr>
                                    <td>{!! $ticket->id !!} </td>
                                    <td>{!! $ticket->title !!}</td>
                                    <td>{!! $ticket->status ? 'Pending' : 'Answered' !!}</td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                @endif
            </div>
    </div>

@endsection
```

**View a single ticket**

At this point, viewing a ticket is much easier. When we click on the title of the ticket, we want to display its content and status.

As usual, open web.php file, and add:
```
		Route::get('/ticket/{slug?}', 'TicketsController@show');
```

You should notice that we use a special route (/ticket/{slug?}) here. By doing this, we tell Laravel that any route parameter named slug will be bound to the show action of our TicketsController.

Next, open TicketsController, update the show action as follows:
```
public function show($slug)
{
    $ticket = Ticket::whereSlug($slug)->firstOrFail();
    return view('tickets.show', compact('ticket'));
}
```

Finally, we return the tickets.show view with the ticket.

We don't have the show view yet. Let's create it:

Create views/tickets/show.blade.php
```
@extends('master')
@section('title', 'View a ticket')
@section('content')
    <div class="container col-md-8 col-md-offset-2">
            <div class="well well bs-component">
                <div class="content">
                    <h2 class="header">{!! $ticket->title !!}</h2>
                    <p> <strong>Status</strong>: {!! $ticket->status ? 'Pending' : 'Answered' !!}</p>
                    <p> {!! $ticket->content !!} </p>
                </div>
                <a href="#" class="btn btn-info">Edit</a>
                <a href="#" class="btn btn-info">Delete</a>
            </div>
    </div>
@endsection
```

**Using a helper function**

Laravel has many helper functions. These PHP functions are really useful. We can use helper functions to manage paths, modify strings, configure our application, etc.

You can find them here:
	
	https://laravel.com/docs/master/helpers

Open tickets/index.blade.php.

Find:
```
   @foreach($tickets as $ticket)
        <tr>
            <td>{!! $ticket->id !!} </td>
            <td>{!! $ticket->title !!}</td>
            <td>{!! $ticket->status ? 'Pending' : 'Answered' !!}</td>
        </tr>
    @endforeach
```

Update to:
```

@foreach($tickets as $ticket)
    <tr>
        <td>{!! $ticket->id !!}</td>
        <td>
            <a href="{!! action('TicketsController@show', $ticket->slug) !!}">{!! $ticket->title !!} </a>
        </td>
        <td>{!! $ticket->status ? 'Pending' : 'Answered' !!}</td>
    </tr>
@endforeach
```

**Edit a ticket**

It's time to move on to create our ticket edit form.

Open web.php, add this route:
```
	Route::get('/ticket/{slug?}/edit','TicketsController@edit');
```

When users go to /ticket/{slug?}/edit, we redirect them to the TicketsController's edit action.

Let's modify the edit action:
```
public function edit($slug)
{
    $ticket = Ticket::whereSlug($slug)->firstOrFail();
    return view('tickets.edit', compact('ticket'));
}
```


We find the ticket using its slug, then we use the tickets.edit view to display the edit form.

Let's create our edit view at resouces/views/tickets/edit.blade.php:

```
@extends('master')
@section('title', 'Edit a ticket')

@section('content')
    <div class="container col-md-8 col-md-offset-2">
        <div class="well well bs-component">
            <form class="form-horizontal" method="post">
                @foreach ($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach

                @if (session('status'))
                    <div class="alert alert-success">
                        {{ session('status') }}
                    </div>
                @endif
                <input type="hidden" name="_token" value="{!! csrf_token() !!}">
                <fieldset>
                    <legend>Edit ticket</legend>
                    <div class="form-group">
                        <label for="title" class="col-lg-2 control-label">Title</label>
                        <div class="col-lg-10">
							<input type="text" class="form-control" id="title" name="title" value="{!! $ticket->title !!}">
                        </div>

                    </div>
						<div class="form-group">
                        <label for="content" class="col-lg-2 control-label">Content</label>
                        <div class="col-lg-10">
                            <textarea class="form-control" rows="3" id="content" name="content">{!! $ticket->content !!}</textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="status" {!! $ticket->status?"":"checked"!!} > Close this ticket?
                        </label>
                    </div>
                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
```


Now, let's open the show view, update the edit button as follows:
```
<a href="{!! action('TicketsController@edit', $ticket->slug) !!}" class="btn btn-info">Edit</a>
```


We use the action helper again! When you click on the edit button, you should be able to access the edit form

We need to use POST method to submit the form.

Open web.php, add:
```
	Route::post('/ticket/{slug?}/edit','TicketsController@update');
```


Then use update action in TicketsController to handle the submission and store the changes.
```
public function update($slug, TicketFormRequest $request)
{
    $ticket = Ticket::whereSlug($slug)->firstOrFail();
    $ticket->title = $request->get('title');
    $ticket->content = $request->get('content');
    if($request->get('status') != null) {
        $ticket->status = 0;
    } else {
        $ticket->status = 1;
    }
    $ticket->save();
    return redirect(action('TicketsController@edit', $ticket->slug))->with('status', 'The ticket '.$slug.' has been updated!');
}
```

**Delete a ticket**

First step, let's open the web.php file:
```
		Route::post('/ticket/{slug?}/delete','TicketsController@destroy');
```

When we send a POST request to this route, Laravel will take the slug and execute the TicketsController's destroy action.

Open TicketsController and update the destroy action:
```
public function destroy($slug)
{
    $ticket = Ticket::whereSlug($slug)->firstOrFail();
    $ticket->delete();
    return redirect('/tickets')->with('status', 'The ticket '.$slug.' has been deleted!');
}
```

As always, we then redirect users to the all tickets page. Let's update the index.blade.php to display the status message:

Find:
```
<div class="panel-heading">
    <h2> Tickets </h2>
</div>
```

Add below:
```
@if (session('status'))
    <div class="alert alert-success">
        {{ session('status') }}
    </div>
@endif
```


Finally, in order to remove the ticket, all we need to do is create a form to submit a delete request.

Open show.blade.php and find:
```
<a href="{!! action('TicketsController@edit', $ticket->slug) !!}" class="btn btn-info">Edit</a>
<a href="#" class="btn btn-info">Delete</a>
```

Update to:
```
<a href="{!! action('TicketsController@edit', $ticket->slug) !!}" class="btn btn-info pull-left">Edit</a>
<form method="post" action="{!! action('TicketsController@destroy', $ticket->slug) !!}" class="pull-left">
    <input type="hidden" name="_token" value="{!! csrf_token() !!}">
        <div>
            <button type="submit" class="btn btn-warning">Delete</button>
        </div>
</form>
<div class="clearfix"></div>
```


**Sending an email**

When users submit a ticket, we may want to receive an email to get notified. In this section, you will learn how to send emails using Laravel.

Laravel provides many methods to send emails. You may use a plain PHP method to send emails, or you may use some email service providers such as Mailgun, Sendinblue, Sendgrid, Mandrill, Amazon SES, etc.

To send emails on a production server, simply edit the mail.php configuration file, which is placed in the config directory.

**Sending emails using Gmail**

edit the .env file:
```
MAIL_DRIVER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=yourEmail
MAIL_PASSWORD=yourPassword
MAIL_ENCRYPTION=tls
```

First, go to:

	https://myaccount.google.com/security#connectedapps
	
Take a look at the Sign-in & security -> Connected apps & sites -> Allow less secure apps settings.

You must turn the option "Allow less secure apps" ON.


If you get this error when sending email: "Failed to authenticate on SMTP server with username "youremail@gmail.com" using 3 possible authenticators"

You may try one of these methods:

Go to

    https://accounts.google.com/UnlockCaptcha

click continue and unlock your account for access through other media/sites.

Using a double quote password: "your password"

Try to use only your Gmail username: yourGmailUsername


**Sending a test email**

To send a test email, open web.php file and add this route:

```
Route::get('sendemail', function () {
    $data = array(
        'name' => "Learning Laravel",
    );
    Mail::send('emails.welcome', $data, function ($message) {
        $message->from('yourEmail@domain.com', 'Learning Laravel');
        $message->to('yourEmail@domain.com')->subject('Learning Laravel test email');
    });
    return "Your email has been sent successfully";
});
```

- Replace yourEmail@domain.com with your real email address.


Finally, we don't have the welcome.blade.php view yet, let's create it and put it in the emails directory.

Create file (with directory) views/emails/welcome.blade.php

Add this code 
```
<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
</head>
<body>
<h2>Learning Laravel!</h2>
<div>
    Welcome to {!! $name !!} website!
</div>
</body>
</html>
```

Check your inbox, you should receive a new email!

Feel free to customize your email address, recipients, subjects, etc.

**Sending an email when there is a new ticket**

Now that we have set up everything, let's send an email when users create a new ticket!

Open TicketsController.php and update the store action.

Find:
```
		return redirect('/contact')->with('status', 'Your ticket has been created! Its unique id is: '.$slug);
```
Add above:
```
    $data = array(
        'ticket' => $slug,
    );

    Mail::send('emails.ticket', $data, function ($message) {
        $message->from('yourEmail@domain.com', 'Learning Laravel');

        $message->to('yourEmail@domain.com')->subject('There is a new ticket!');
    });
```

And don't forget to tell Laravel that you want to use the Mail facade here:

Find:
```
		class TicketsController extends Controller
```
Add above:
```
		use Illuminate\Support\Facades\Mail;
```


As you may notice, we don't have the emails/ticket.blade.php view yet. Let's create it!
```
<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="utf-8">
</head>
<body>
<h2>Learning Laravel!</h2>

<div>
    You have a new ticket. The ticket id is {!! $ticket !!}!
</div>

</body>
</html>
```

**Reply to a ticket**

Welcome to the last section!

In this section, we will learn how to create a form for users to post a reply.

**Create a new comments table**

First, we need a table to store all the ticket responses. I name this table comments.

Let's run this migration command:
```
	php artisan make:migration create_comments_table --create=comments
```

Then, open yourTimestamps_create_comments_table.php, use Schema to create some columns:
```
<?php
use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;
class CreateCommentsTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::create('comments', function (Blueprint $table) {
            $table->increments('id');
            $table->text('content');
            $table->integer('post_id');
            $table->integer('user_id')->nullable();
            $table->tinyInteger('status')->default(1);
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::dropIfExists('comments');
    }
}
```

You should know how to read this file by now. Let's run the migrate command to create the comments table and its columns:
```
 php artisan migrate
```

**Introducing Eloquent: Relationships**

In Laravel, you can maintain a relationship between tables easily using Eloquent. Here are the relationships that Eloquent supports:

- One to One
- One to Many
- Many to Many
- Has Many Through
- Polymorphic Relations
- Many To Many Polymorphic Relations

What is a relationship?

Usually, tables are related to each other. For instance, our tickets may have many comments (ticket responses). That is One to Many relationship.

Once we've defined a One to Many relationship between tickets and comments table, we can easily access and list all comments or any related records.

Learn more about Eloquent relationships here:
	https://laravel.com/docs/master/eloquent-relationships

	
**Create a new Comment model**

As you know, we need a Comment model! Run this command to create it:
```
php artisan make:model Comment
```

Once completed, open it and add this relationship:
```
    public function ticket()
    {
        return $this->belongsTo('App\Ticket');
    }
```
In addition, we may want to make all columns mass assignable except the id column:
```
			protected $guarded = ['id'];
```

Instead of using the $fillable property, we use the $guarded property here.

You now have:
```
app/Comment.php

<?php

namespace App;

use Illuminate\Database\Eloquent\Model;

class Comment extends Model
{
    protected $guarded = ['id'];

    public function ticket()
    {
        return $this->belongsTo('App\Ticket');
    }
}
```

By doing this, we let Eloquent know that this Comment model belongs to the Ticket model.

Next, open the Ticket model and add:
```
public function comments()
{
    return $this->hasMany('App\Comment', 'post_id');
}
```

**Create a new comments controller**

With the relation defined, we will create a new CommentsController to handle form submissions and save comments to our database.

Before doing that, let's modify our web.php first:
```
Route::post('/comment', 'CommentsController@newComment');
```

It's time to run this command to generate our controller:
```
php artisan make:controller CommentsController
```

Open the new CommentsController and add a new action:
```
<?php
namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Http\Requests\CommentFormRequest;
use App\Comment;
class CommentsController extends Controller
{
    public function newComment(CommentFormRequest $request)
    {
        $comment = new Comment(array(
            'post_id' => $request->get('post_id'),
            'content' => $request->get('content')
        ));
        $comment->save();
        return redirect()->back()->with('status', 'Your comment has been created!');
    }
}
```

**Create a new CommentFormRequest**

We don't have the CommentFormRequest yet, so let's create it as well:
```
php artisan make:request CommentFormRequest
```

Now, define our rules:
```
<?php
namespace App\Http\Requests;

use Illuminate\Foundation\Http\FormRequest;
class CommentFormRequest extends FormRequest
{
    /**
     * Determine if the user is authorized to make this request.
     *
     * @return bool
     */
    public function authorize()
    {
        return true;
    }
 /**
     * Get the validation rules that apply to the request.
     *
     * @return array
     */
    public function rules()
    {
        return [
            'content'=> 'required|min:3',
        ];
    }
}
```

**Create a new reply form**

Now open the tickets.show view and add this form:
```
 <div class="well well bs-component">
            <form class="form-horizontal" method="post" action="/comment">

                @foreach($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach

                @if(session('status'))
                    <div class="alert alert-success">
                        {{ session('status') }}
                    </div>
                @endif

                <input type="hidden" name="_token" value="{!! csrf_token() !!}">
                <input type="hidden" name="post_id" value="{!! $ticket->id !!}">

 <fieldset>
                    <legend>Reply</legend>
                    <div class="form-group">
                        <div class="col-lg-12">
                            <textarea class="form-control" rows="3" id="content" name="content"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="reset" class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Post</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
```

Here is the new tickets.show view:
```
@extends('master')
@section('title', 'View a ticket')
@section('content')

    <div class="container col-md-8 col-md-offset-2">
        <div class="well well bs-component">
            <div class="content">
                <h2 class="header">{!! $ticket->title !!}</h2>
                <p> <strong>Status</strong>: {!! $ticket->status ? 'Pending' : 'Answered' !!}</p>
                <p> {!! $ticket->content !!} </p>
            </div>
            <a href="{!! action('TicketsController@edit', $ticket->slug) !!}" class="btn btn-info pull-left">Edit</a>

            <form method="post" action="{!! action('TicketsController@destroy', $ticket->slug) !!}" class="pull-left">
                <input type="hidden" name="_token" value="{!! csrf_token() !!}">
                <div>
                    <button type="submit" class="btn btn-warning">Delete</button>
                </div>
            </form>

            <div class="clearfix"></div>
        </div>

        <div class="well well bs-component">
            <form class="form-horizontal" method="post" action="/comment">

                @foreach($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach

                @if(session('status'))
                    <div class="alert alert-success">
                        {{ session('status') }}
                    </div>
                @endif

                <input type="hidden" name="_token" value="{!! csrf_token() !!}">
                <input type="hidden" name="post_id" value="{!! $ticket->id !!}">

                <fieldset>
                    <legend>Reply</legend>
                    <div class="form-group">
                        <div class="col-lg-12">
                            <textarea class="form-control" rows="3" id="content" name="content"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="reset" class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Post</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>

    </div>

@endsection
```

**Display the comments**

One last step, we're going to modify the show action of our TicketsController to list all ticket's comments and pass them to the view.

Open TicketsController. The changes in the show action are listed as follows:
```
public function show($slug)
{
    $ticket = Ticket::whereSlug($slug)->firstOrFail();
    $comments = $ticket->comments()->get();
    return view('tickets.show', compact('ticket', 'comments'));
}
```
Now, open the show.blade.php view, and add this code above the reply form:
```
@foreach($comments as $comment)
    <div class="well well bs-component">
        <div class="content">
            {!! $comment->content !!}
        </div>
    </div>
@endforeach
```

Here is the new views/tickets/show.blade.php:
```
@extends('master')
@section('title', 'View a ticket')
@section('content')

    <div class="container col-md-8 col-md-offset-2">
        <div class="well well bs-component">
            <div class="content">
                <h2 class="header">{!! $ticket->title !!}</h2>
                <p> <strong>Status</strong>: {!! $ticket->status ? 'Pending' : 'Answered' !!}</p>
                <p> {!! $ticket->content !!} </p>
            </div>
            <a href="{!! action('TicketsController@edit', $ticket->slug) !!}" class="btn btn-info pull-left">Edit</a>

            <form method="post" action="{!! action('TicketsController@destroy', $ticket->slug) !!}" class="pull-left">
                <input type="hidden" name="_token" value="{!! csrf_token() !!}">
                <div>
                    <button type="submit" class="btn btn-warning">Delete</button>
                </div>
            </form>

            <div class="clearfix"></div>
        </div>

        @foreach($comments as $comment)
            <div class="well well bs-component">
                <div class="content">
                    {!! $comment->content !!}
                </div>
            </div>
        @endforeach

        <div class="well well bs-component">
            <form class="form-horizontal" method="post" action="/comment">

                @foreach($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach

                @if(session('status'))
                    <div class="alert alert-success">
                        {{ session('status') }}
                    </div>
                @endif

                <input type="hidden" name="_token" value="{!! csrf_token() !!}">
                <input type="hidden" name="post_id" value="{!! $ticket->id !!}">

                <fieldset>
                    <legend>Reply</legend>
                    <div class="form-group">
                        <div class="col-lg-12">
                            <textarea class="form-control" rows="3" id="content" name="content"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="reset" class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Post</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>

    </div>

@endsection
```

**Refresh your browser now!!**


**Chapter Summary**

In this chapter, you've gone through the different steps involved in creating a ticket support system. Even though the app is simple, it provides us many things to learn:

- You've known how to create **databases**.
- You've learned one of the most important Laravel features: **migrations**. Now you can create any database structures that you want.
- You've understood how to use **Request** to **validate** forms.
- If you want to use different **packages**, you've known how to install them.
- You've learned about Laravel's **helper** functions.
- Sending **emails** using Gmail and Sendinblue is easy, right?
- You've known how to define **Eloquent Relationships** and work with those relationships easily.
- Basically, you may now be able to create a simple blog system. Feel free to build a different application or customize this application to meet your needs.
- The next chapter is where all the fun begin! You will learn to create a **complete blog application** that has an **admin control panel**.
You may use this application to write your blog posts or you may use it as a starter template for all your amazing applications.

**The End**