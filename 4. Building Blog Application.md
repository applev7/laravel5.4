**Building A Blog Application**

we will learn about Laravel Authentication, Seeding, Localization, Middleware and many useful features

What do we need to get started? 

I assume that you have followed the instructions provided in the previous chapter and you've created a support ticket system. 

We will use the previous application as our template.

What will we build? 

Our simple blog application will have these features:
- Users can be able to register and login.
- Admin can write posts.
- Users can be able to comment on the posts.
- There is an admin control panel to manage users, posts (create, update, delete)
- Permissions and roles system.
- Admin can create/remove/edit categories.

Let's get started!

**Building a user registration page**

Since Laravel 5, implementing authentication has become very easy, Laravel has provided almost everything for us.

In this section, you will learn how to create a simple registration page.

By default, Laravel has created some authentication controllers for us:

- RegisterController: handles new user registration.
- LoginController: handles authentication (login).
- ForgotPasswordController: sends emails to users with a link to reset their password.
- ResetPasswordController: reset users' password.

You can find them in the app/Http/Controllers/Auth directory.


First, let's take a look at our database, we should see that the users table has been created.

As mentioned before, Laravel comes with a default user migration, which is placed in the database/migrations directory:

We can generate all routes and views for our authentication system using Laravel Auth Scaffold. We just need to run this command:
```
php artisan make:auth
```

we would need some routes for our registration form. We can open web.php and add these routes:
```
Route::get('users/register', 'Auth\RegisterController@showRegistrationForm');
Route::post('users/register', 'Auth\RegisterController@register');
```

Let's open the RegisterController and take a look at:
```
protected function validator(array $data)
{
    return Validator::make($data, [
        'name' => 'required|max:255',
        'email' => 'required|email|max:255|unique:users',
        'password' => 'required|min:6|confirmed',
    ]);
}
```
Unfortunately, Laravel doesn't create the registration view for us, we have to create it manually. 

The registration views should be placed at resources/views/auth/register.blade.php.

Here is the code:
```
@extends('master')
@section('name', 'Register')
@section('content')
    <div class="container col-md-6 col-md-offset-3">
        <div class="well well bs-component">
            <form class="form-horizontal" method="post">

                @foreach ($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach
                 {!! csrf_field() !!}

                <fieldset>
                    <legend>Register an account</legend>
                    <div class="form-group">
                        <label for="name" class="col-lg-2 control-label">Name</label>
                        <div class="col-lg-10">
                            <input type="text" class="form-control" id="name" placeholder="Name" name="name" value="{{ old('name') }}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="email" class="col-lg-2 control-label">Email</label>
                        <div class="col-lg-10">
                            <input type="email" class="form-control" id="email" placeholder="Email" name="email" value="{{ old('email') }}">
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="password" class="col-lg-2 control-label">Password</label>
                        <div class="col-lg-10">
                            <input type="password" class="form-control"  name="password">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="password" class="col-lg-2 control-label">Confirm password</label>
                        <div class="col-lg-10">
                            <input type="password" class="form-control"  name="password_confirmation">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="reset" class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
```

Here is a new tip. Instead of using this line to generate a new CSRF token:
```
<input type="hidden" name="_token" value="{!! csrf_token() !!}">
```
You can simply use this helper function to generate the token!
```
{!! csrf_field() !!}
```

Fill in all the fields, and hit submit! You've registered a new user!

Check your database now, you should see the user you registered.


By default, Laravel automatically redirects you to the /home URI. If you see this error when you're at http://homestead.app/home:
```
NotFoundHttpException in RouteCollection.php line 161:
```
Then that means your web.php file doesn't have the home route:
```
Route::get('home', 'PagesController@home');
```
You can fix this error by adding the home route into your app or you can open the RegisterController and take a look at:
```
/**
 * Where to redirect users after login / registration.
 *
 * @var string
 */
protected $redirectTo = '/home';
```

**Creating a logout functionality**

We don't have the logout functionality yet, but don't worry, it's very easy to implement.

Open the shared/navbar.blade.php view, find:
```
<li><a href="/users/register">Register</a></li>
<li><a href="/users/login">Login</a></li>
```

Replace with the following code:
```
@if (Auth::check())
    <li><a href="/users/logout">Logout</a></li>
@else
    <li><a href="/users/register">Register</a></li>
    <li><a href="/users/login">Login</a></li>
@endif
```

To make the link work, open web.php, add:
```
Route::get('users/logout', 'Auth\LoginController@logout');
```

As you see, when users visit the users/logout link, we will use LoginController's getLogout action to log the users out.

Try to test the functionality yourself! Now you can be able to log out!

**Creating a login page**

It's time to create our login form. As always, we're going to define two different actions on the users/login route:
```
Route::get('users/login', 'Auth\LoginController@showLoginForm');
Route::post('users/login', 'Auth\LoginController@login');
If you not already have login view, you should create now. The view should be placed at views/auth/login.blade.php. If you already have, modify to use below code;
@extends('master')
@section('name', 'Login')

@section('content')
    <div class="container col-md-6 col-md-offset-3">
        <div class="well well bs-component">
            <form class="form-horizontal" method="post">
                @foreach ($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach
                 {!! csrf_field() !!}
                <fieldset>
                    <legend>Login</legend>

                    <div class="form-group">
                        <label for="email" class="col-lg-2 control-label">Email</label>
                        <div class="col-lg-10">
                            <input type="email" class="form-control" id="email" name="email" value="{{ old('email') }}">
                        </div>
                    </div>

                  
 <div class="form-group">
                        <label for="password" class="col-lg-2 control-label">Password</label>
                        <div class="col-lg-10">
                            <input type="password" class="form-control"  name="password">
                        </div>
                    </div>
                    <div class="checkbox">
                        <label>
                            <input type="checkbox" name="remember" > Remember Me?
                        </label>
                    </div>
                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="submit" class="btn btn-primary">Login</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
```

One last step, don't forget to open the LoginController and change the $redirectTo variable:
```
protected $redirectTo = '/';
```
Now everything should be working fine.

Let's go to http://yourlocalhost:8800/users/login and try to login with your email and password!

**Authentication Throttling in your application**

Laravel 5.1.4 introduces a new feature: "Authentication Throttling". 

This feature is used to throttle login attempts to your application. 

If users try to login many times, they won't be able to login for one minute.

Because we're using Laravel 5.4 and the Laravel's built-in LoginController class for authentication, this feature has been implemented already.

Now, let's try to login with wrong credentials.

When you try to login many times, an error message would appear:

**Building an admin area**

Imagine that our application will have an administration section and a front end section, there would be many routes. We need to find a way to organize all the routes.

Additionally, we may want to allow only administrators to access our admin area. Fortunately, Laravel helps us to do that easily.

Let's open web.php file and add:
```
Route::group(array('prefix' => 'admin', 'namespace' => 'Admin', 'middleware' => 'auth'), function () {
    Route::get('users', 'UsersController@index');
});
```

By using Route::group we can group all related routes together and apply some specific rules for them.

Laravel 5.4 uses PSR-4 autoloading standard, which is a coding style. Your applications controllers, models and other classes must be namespaced.

What are namespaces? According to PHP docs: "namespaces are designed to solve two problems that authors of libraries and applications encounter when creating re-usable code elements such as classes or functions.". 

Simply put, let's think namespaces as the last names of persons. When many persons have the same name, we will use their last name to distinguish them apart.

To namespace a class, we can use the namespace keyword and declare the namespace at the top of the file before any other code. For instance, let's open RegisterController.php class, you should see its namespace:
```
<?php
namespace App\Http\Controllers\Auth;
```
As you may have seen, I have defined a namespace called Admin for our routes:
```
 		'namespace' => 'Admin'
```
If we have a class that has a namespace like this:
```
		<?php
		namespace App\Http\Controllers\Admin;
```

Laravel will know exactly which class that we want to load and where to find it.

Laravel 5 also has a new feature called HTTP Middleware (or simply Middleware). Basically, we use it to filter our applications' HTTP requests. For example, I use:
```
'middleware' => 'auth'
```
That means I want to use the auth middleware for this route group. Only authenticated users can access these routes. 

**List all users**

We now have a route group for our admin control panel. Let's list all the users so that we can view and manage them easier.

As you know, we have defined a route here:
```
Route::get('users', 'UsersController@index');
```
We also don't have the UsersController yet, let's use PHP Artisan to create it:
```
php artisan make:controller Admin/UsersController
```
First, we tell Laravel that we want to use the User model:

Find:
```
use App\Http\Controllers\Controller;
```
Add below:
```
use App\User;
```

Now, add a new index() action as follows:
```
		public function index()
		{
    			$users = User::all();
    			return view('backend.users.index', compact('users'));
		}
```

We're going to create a new view called index.blade.php to display all the users. Let's create a new users directory as well and put the index view inside.

So the index view will be placed at views/backend/users/index.blade.php.



Here is the code:
```
@extends('master')
@section('title', 'All users')
@section('content')

    <div class="container col-md-8 col-md-offset-2">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h2> All users </h2>
            </div>
            @if (session('status'))
                <div class="alert alert-success">
                    {{ session('status') }}
                </div>
            @endif
            @if ($users->isEmpty())
                <p> There is no user.</p>
            @else
                <table class="table">
                    <thead>
                    <tr>

                        <th>ID</th>                       
                        <th>Name</th>
                        <th>Email</th>
                        <th>Joined at</th>

                    </tr>
                    </thead>
                    <tbody>
                    @foreach($users as $user)
                        <tr>
                            <td>{!! $user->id !!}</td>
                            <td>
                                <a href="#">{!! $user->name !!} </a>
                            </td>
                            <td>{!! $user->email !!}</td>
                            <td>{!! $user->created_at !!}</td>
                        </tr>
                    @endforeach
                    </tbody>
                </table>
            @endif
        </div>
    </div>

@endsection
```

If you don't login and visit the page, you will get an error:

Laravel will redirect you to http://yourlocalhost:8800/login as well.

Don't worry, it's because our middleware is working fine.

To fix this issue, just open app/Exception/Handler.php and find:
```
return redirect()->guest('login');
```
Change it to:
```
return redirect()->guest('users/login');
```

**All about Middleware**

One of the best new features of Laravel 5 is Middleware (aka HTTP Middleware). Imagine that you have a layer between all requests and responses. 

That layer will help to handle all requests and return proper responses, even before the requests/responses are processed. We call the layer: "Middleware".

Take a look at the docs to learn more about it:

	https://laravel.com/docs/master/middleware

We can use middleware to do many things. For example, middleware can help to authenticate users, log data for analytics, add CSRF protection, etc.


You can find some middleware in the app/Http/Middleware directory. Open the directory, you'll see these middleware:

- EncryptCookies middleware: Used to encrypt the application's cookies.
- RedirectIfAuthenticated middleware: Redirect users to a page if they're not authenticated.
- VerifyCsrfToken middleware: Used to manage RSRF tokens.
- TrimStrings middleware: used to automatically trim all the request data.

Note: In Laravel 5.4, the Authenticated middleware has been removed. This middleware is responsible for authenticating users. If users are not logged in, they are redirected to the login page.

**Creating a new middleware**

Now let's say that we wanted to use a new middleware called Manager to make sure that only administrators can access the admin area.

Creating a new middleware is easy, simply run this Artisan command:
```
php artisan make:middleware Manager 
```

A new middleware called Manager will be created. You can find it in the Middleware directory.

One more step to do, we need to register the Manager middleware. Let's open the Kernel.php file, which can be found in the Http directory.

There are three properties: $middleware, $middlewareGroups and $routeMiddleware.

If you want to enable a middleware for every route, you can append it to the $middleware property. For example, you may add the Manager class like this:
```
	protected $middleware = [ 	
		\Illuminate\Foundation\Http\Middleware\CheckForMaintenanceMode::class, 	
		\App\Http\Middleware\Manager::class, 
	];
```

***don't copy code above, it just an example

If you want to enable a middleware for just the web group (the routes/web.php), you can append it to the $middlewareGroups property:
```
protected $middlewareGroups = [
    'web' => [
        \App\Http\Middleware\EncryptCookies::class,
        \Illuminate\Cookie\Middleware\AddQueuedCookiesToResponse::class,
        \Illuminate\Session\Middleware\StartSession::class,
        \Illuminate\View\Middleware\ShareErrorsFromSession::class,
        \App\Http\Middleware\VerifyCsrfToken::class,
        \Illuminate\Routing\Middleware\SubstituteBindings::class,
        \App\Http\Middleware\Manager::class,
    ],
    'api' => [
        'throttle:60,1',
        'bindings',
    ],
];
```

***don't copy code above, it just an example

However, we just want to assign the Manager middleware to our admin route group. Therefore, all we need to do is append the Manager middleware to the $routeMiddleware property.
Add following code to Manager.
```
protected $routeMiddleware = [
    'auth' => \Illuminate\Auth\Middleware\Authenticate::class,
    'auth.basic' => \Illuminate\Auth\Middleware\AuthenticateWithBasicAuth::class,
    'bindings' => \Illuminate\Routing\Middleware\SubstituteBindings::class,
    'can' => \Illuminate\Auth\Middleware\Authorize::class,
    'guest' => \App\Http\Middleware\RedirectIfAuthenticated::class,
    'throttle' => \Illuminate\Routing\Middleware\ThrottleRequests::class,
    'manager' => \App\Http\Middleware\Manager::class,
];
```
Next, open web.php and modify the admin route group to enable the Manager middleware:

Change to:
```
Route::group(array('prefix' => 'admin', 'namespace' => 'Admin', 'middleware' => 'manager'), function () {
    Route::get('users', 'UsersController@index');
});
```
Well done! Our manager middleware is now active.

You've got a solid foundation of Middleware. Keep in mind that you can use Middleware to do many things.

Even though our Manager middleware is working properly, we can't see any difference. The reason is, we don't create any request filters yet.

If we want to restrict access to the admin area, we need to add roles or permissions to our users.

Fortunately, Laravel has many packages that we can use to implement the features easily:

- Entrust: This is the most popular package for adding Role-based Permissions to Laravel 5. However, it's not updated frequently.
- laravel-permission: This is a new package but it's powerful and very easy to use. It is built upon Laravel's authorization functionality.

Because laravel-permission is well maintained, we'll be using it.

**Adding roles and permission to our app using laravel-permission**

You can install laravel-permission by running this command:
```
composer require spatie/laravel-permission
```
Now, open the config/app.php file and find the providers array, add:
```
'providers' => [
    ...
    Spatie\Permission\PermissionServiceProvider::class,
];
```
Next, we can publish the migration using this command:
```
	php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider" --tag="migrations 
```
A new timestamp_create_permission_tables migration file will be created.

After that, we can create the role and permission tables using:
```
php artisan migrate
```
Check your database, you should see some new tables.

We can publish laravel-permission config file by running this command:
```
	php artisan vendor:publish --provider="Spatie\Permission\PermissionServiceProvider" --tag="config"
```
A new laravel-permission.php file will be created in the config directory.

Last step, open our User model (app/User.php) and update as follows:
```
		use Illuminate\Foundation\Auth\User as Authenticatable;
		use Spatie\Permission\Traits\HasRoles;

		class User extends Authenticatable
		{
   			use HasRoles;
```
 Good job! You've installed laravel-permission!

 **Create a new role**

Once installed, we can be able to create user roles. Let's say we will have two roles: manager and member.

As an exercise let's create a simple role creation form:

First, edit the web.php file and update the admin route group as follows:
```
	Route::group(array('prefix' => 'admin', 'namespace' => 'Admin', 'middleware' => 'manager'), function () {
    		Route::get('users', [ 'as' => 'admin.user.index', 'uses' => 'UsersController@index']);
    		Route::get('roles', 'RolesController@index');
    		Route::get('roles/create', 'RolesController@create');
    		Route::post('roles/create', 'RolesController@store');
	});
```

Again, create RolesController by running this command:
```
php artisan make:controller Admin/RolesController
```

Open RolesController, add a new create action as follows:
```
		class RolesController extends Controller
		{
    			public function create()
    			{
        				return view('backend.roles.create');
    			}
		}
```
Create a new roles directory, place it inside the views/backend directory. Then create a new view called views/backend/create.blade.php:
```
@extends('master')
@section('title', 'Create A New Role')

@section('content')
    <div class="container col-md-8 col-md-offset-2">
        <div class="well well bs-component">

            <form class="form-horizontal" method="post">

                @foreach ($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach

                @if (session('status'))
                    <div class="alert alert-success">
                        {{ session('status') }}
                    </div>
                @endif

                <input type="hidden" name="_token" value="{!! csrf_token() !!}">

				<fieldset>
                    <legend>Create a new role</legend>
                    <div class="form-group">
                        <label for="name" class="col-lg-2 control-label">Name</label>
                        <div class="col-lg-10">
                            <input type="text" class="form-control" id="name" name="name">
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="reset" class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
```

We should have a nice role creation form at http://yourlocalhst:8000/admin/roles/create.

Next, let's add a new store action into the RolesController to save the data:
```
public function store(RoleFormRequest $request)
{
    Role::create(['name' => $request->get('name')]);

    return redirect('/admin/roles/create')->with('status', 'A new role has been created!');
}
```
We use RoleFormRequest here to validate the form, but we don't have the request file yet. Let's create it:
```
php artisan make:request RoleFormRequest
```
Set return true in authorize method.

Add this in rules method
```
return [
        'name' => 'required',
    ];
```
Be sure that you have told Laravel that you want to use Role, Permission and RoleFormRequest in the RolesController:
```
<?php
namespace App\Http\Controllers\Admin;

use Illuminate\Http\Request;
use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\Http\Requests\RoleFormRequest;
use Spatie\Permission\Models\Role;
use Spatie\Permission\Models\Permission;

class RolesController extends Controller
{
```
Now, go to http://homestead.app/admin/roles/create and create two new roles: manager and member.

To view all roles, add a new index action of our RolesController as follows:
```
public function index()
{
    $roles = Role::all();
    return view('backend.roles.index', compact('roles'));
}
```
Then create a new index view at views/backend/roles/index.blade.php:

views/backend/roles/index.blade.php 
```
@extends('master')
@section('title', 'All roles')
@section('content')

    <div class="container col-md-8 col-md-offset-2">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h2> All roles </h2>
            </div>
            @if (session('status'))
                <div class="alert alert-success">
                    {{ session('status') }}
                </div>
            @endif
            @if ($roles->isEmpty())
                <p> There is no role.</p>
            @else

                <table class="table">
                    <thead>
                    <tr>
                        <th>Name</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach($roles as $role)
                        <tr>
                            <td>{!! $role->name !!}</td>
                        </tr>
                    @endforeach
                    </tbody>
                </table>
            @endif
        </div>
    </div>

@endsection
```
**Assign roles to users**

In this section, we will learn how to edit users and assign roles to them.

Let's start by adding these routes to our admin route group:
```
Route::get('users/{id?}/edit', 'UsersController@edit');
Route::post('users/{id?}/edit','UsersController@update');
```
Next, open users/index.blade.php view and find:
```
<a href="#">{!! $user->name !!} </a>
```
Update the link to:
```
<a href="{!! action('Admin\UsersController@edit', $user->id) !!}">{!! $user->name !!} </a>
```
Open UsersController, add a new edit action:
```
public function edit($id)
{
    $user = User::whereId($id)->firstOrFail();
    $roles = Role::all();
    $selectedRoles = $user->roles()->pluck('name')->toArray();
    return view('backend.users.edit', compact('user', 'roles', 'selectedRoles'));
}
```
Don't forget to add this line at the top of the UsersController:
```
use Spatie\Permission\Models\Role;
```



Add the roles fields to users/edit.blade.php
```
  <div class="form-group">
        <label for="select" class="col-lg-2 control-label">Role</label>
        <div class="col-lg-10">
            <select class="form-control" id="role" name="role[]" multiple>
                @foreach($roles as $role)
                    <option value="{!! $role->name !!}"
                          @if(in_array($role->name, $selectedRoles))
                                  selected="selected"
                          @endif >  {!! $role->name !!}
                    </option>
                @endforeach
            </select>
        </div>
    </div>
```
Here is the users/edit view:

users/edit.blade.php
```
@extends('master')
@section('name', 'Edit a user')

@section('content')
    <div class="container col-md-6 col-md-offset-3">
        <div class="well well bs-component">

            <form class="form-horizontal" method="post">

                @foreach ($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach

                @if (session('status'))
                    <div class="alert alert-success">
                        {{ session('status') }}
                    </div>
                @endif

                {!! csrf_field() !!}

                <fieldset>
                    <legend>Edit user</legend>
                    <div class="form-group">
                        <label for="name" class="col-lg-2 control-label">Name</label>

                        <div class="col-lg-10">
                            <input type="text" class="form-control" id="name" placeholder="Name" name="name"
                                   value="{{ $user->name }}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email" class="col-lg-2 control-label">Email</label>

                        <div class="col-lg-10">
                            <input type="email" class="form-control" id="email" placeholder="Email" name="email"
                                   value="{{ $user->email }}">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="select" class="col-lg-2 control-label">Role</label>

                        <div class="col-lg-10">
                            <select class="form-control" id="role" name="role[]" multiple>
                                @foreach($roles as $role)
                                    <option value="{!! $role->name !!}"  @if(in_array($role->name, $selectedRoles))
                                    selected="selected" @endif >{!! $role->name !!}
                                    </option>
                                @endforeach
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="password" class="col-lg-2 control-label">Password</label>

                        <div class="col-lg-10">
                            <input type="password" class="form-control" name="password">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="password" class="col-lg-2 control-label">Confirm password</label>

                        <div class="col-lg-10">
                            <input type="password" class="form-control" name="password_confirmation">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="reset" class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
```
**Update Controller**

If you click the Submit button now, nothing will happen. We have to add a new UsersController's update action to save data to our database:
```
public function update($id, UserEditFormRequest $request)
{
    $user = User::whereId($id)->firstOrFail();
    $user->name = $request->get('name');
    $user->email = $request->get('email');
    $password = $request->get('password');
    if($password != "") {
        $user->password = Hash::make($password);
    }
    $user->save();
    $user->syncRoles($request->get('role'));
    return redirect(action('Admin\UsersController@edit', $user->id))->with('status', 'The user has been updated! 
); 
```
We use user's id to find the user and then save the changes to the database using $user->save() method.

We'll need to include the Hash facade and UserEditFormRequest as well. Find:
```
class UsersController extends Controller
```
Add above it:
```
use App\Http\Requests\UserEditFormRequest;
use Illuminate\Support\Facades\Hash;
```
Here is our updated UsersController file:
```
<?php

namespace App\Http\Controllers\Admin;

use Illuminate\Http\Request;

use App\Http\Requests;
use App\Http\Controllers\Controller;
use App\User;

use Spatie\Permission\Models\Role;
use App\Http\Requests\UserEditFormRequest;
use Illuminate\Support\Facades\Hash;

class UsersController extends Controller
{
    public function index()
    {
        $users = User::all();

        return view('backend.users.index', compact('users'));
    }

    public function edit($id)
    {
        $user = User::whereId($id)->firstOrFail();
        $roles = Role::all();
        $selectedRoles = $user->roles()->pluck('name')->toArray();
        return view('backend.users.edit', compact('user', 'roles', 'selectedRoles'));
    }

    public function update($id, UserEditFormRequest $request)
    {
        $user = User::whereId($id)->firstOrFail();
        $user->name = $request->get('name');
        $user->email = $request->get('email');
        $password = $request->get('password');
        if($password != "") {
            $user->password = Hash::make($password);
        }
        $user->save();

        $user->syncRoles($request->get('role'));

        return redirect(action('Admin\UsersController@edit', $user->id))->with('status', 'The user has been updated!');
    }
}
```

As always, generate the UserEditFormRequest by running this command:
```
php artisan make:request UserEditFormRequest
```
Now go to UserEditFormRequest and modify to 
```
public function authorize()
{
    return true;
}
```
And
``` 
public function rules()
{
    return [
        'name' => 'required',
        'email'=> 'required',
        'role'=> 'required',
    ];
}
```
Sweet! Now let's try to assign a role to a user!

**Restrict access to Manager users**

Absolutely, we don't want anyone to access the admin area, except our Manager users. Open our Manager middleware:
```
public function handle($request, Closure $next)
{
    return $next($request);
}
```
In the handle method, add this 
```
if(!Auth::check()) {
            return redirect('users/login');
        } else {
            $user = Auth::user();
            if($user->hasRole('manager'))
            {
                return $next($request);
            } else {
                return redirect('/');
            }
        }
```
**Create an admin dashboard page**

Let's move onto creating the admin home page now so that we can access the admin area easily.

Update our web.php file, add this route into the admin route group:
```
Route::get('/', 'PagesController@home');
```
Next, create the Admin/PagesController:
```
php artisan make:controller Admin/PagesController
```
Add new home method to admin backend.
```
<?php
namespace App\Http\Controllers\Admin;

use Illuminate\Http\Request;
use App\Http\Controllers\Controller;
class PagesController extends Controller
{
    public function home()
    {
        return view('backend.home');
    }
}
```
Finally, create a new home view (home.blade.php) in the backend directory:
```
@extends('master')
@section('title', 'Admin Control Panel')

@section('content')
    <div class="container">
        <div class="row banner">
            <div class="col-md-12">
                <div class="list-group">
                    <div class="list-group-item">
                        <div class="row-action-primary">
                            <i class="material-icons">face</i>
                        </div>
                        <div class="row-content">
                            <div class="action-secondary"><i class="material-icons">account_box</i></div>
                            <h4 class="list-group-item-heading">Manage User</h4>
                            <a href="/admin/users" class="btn btn-default btn-raised">All Users</a>
                        </div>
                    </div>
                    <div class="list-group-separator"></div>
                    <div class="list-group-item">
                        <div class="row-action-primary">
                            <i class="material-icons">supervisor_account</i>
                        </div>
                        <div class="row-content">
                            <div class="action-secondary"><i class="material-icons">accessibility</i></div>
                            <h4 class="list-group-item-heading">Manage Roles</h4>
                            <a href="/admin/roles" class="btn btn-default btn-raised">All Roles</a>
                            <a href="/admin/roles/create" class="btn btn-primary btn-raised">Create A Role</a>
                        </div>
                    </div>
                    <div class="list-group-separator"></div>
                    <div class="list-group-item">
                        <div class="row-action-primary">
                            <i class="material-icons">content_copy</i>
                        </div>
                        <div class="row-content">
                            <div class="action-secondary"><i class="material-icons">border_color</i></div>
                            <h4 class="list-group-item-heading">Manage Posts</h4>
                            <a href="/admin/posts" class="btn btn-default btn-raised">All Posts</a>
                            <a href="/admin/posts/create" class="btn btn-primary btn-raised">Create A Post</a>
                        </div>
                    </div>
                    <div class="list-group-separator"></div>
                </div>
            </div>
        </div>
    </div>
@endsection
```

One more thing, how about adding a link to our navigation bar to access the admin area easier? Open the shared/navbar view and find:
```
		@if (Auth::check())
   			<li><a href="/users/logout">Logout</a></li>
		@else
```
Update to:
```
		@if (Auth::check())
		    @role('manager')
		        <li><a href="/admin">Admin</a></li>
		    @endrole
		    <li><a href="/users/logout">Logout</a></li>
		@else
```
**Create a new post**

To get started, let's create a new Post model and its migration:
```
php artisan make:model Post -m
```
Open timestamp_create_posts_table.php, which can be found in the migrations directory. Update the up method as follows:
```
public function up()
{
    Schema::create('posts', function (Blueprint $table) {
        $table->increments('id');
        $table->string('title', 255);
        $table->text('content');
        $table->string('slug')->nullable();
        $table->tinyInteger('status')->default(1);
        $table->integer('user_id')->nullable();
        $table->timestamps();
    });
}
```
And run :
```
php artisan migrate
```

Open web.php, add these routes to the admin route group:
```
Route::get('posts', 'PostsController@index');
Route::get('posts/create', 'PostsController@create');
Route::post('posts/create', 'PostsController@store');
Route::get('posts/{id?}/edit', 'PostsController@edit');
Route::post('posts/{id?}/edit','PostsController@update');
```

Create a new Admin/PostsController by running this command:
```

php artisan make:controller Admin/PostsController --resource
```

Open Admin/PostsController, update the create action as follows:
```
public function create()
{
    return view('backend.posts.create');
}
```
Create a new posts folder in the backend directory. Place a new create view there:
```
@extends('master')
@section('title', 'Create A New Post')

@section('content')
    <div class="container col-md-8 col-md-offset-2">
        <div class="well well bs-component">
            <form class="form-horizontal" method="post">
                @foreach ($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach
                @if (session('status'))
                    <div class="alert alert-success">
                        {{ session('status') }}
                    </div>
                @endif
                <input type="hidden" name="_token" value="{!! csrf_token() !!}">
                <fieldset>
                    <legend>Create a new post</legend>
                    <div class="form-group">
		 <label for="title" class="col-lg-2 control-label">Title</label>

	<div class="col-lg-10">
                            <input type="text" class="form-control" id="title" placeholder="Title" name="title">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="content" class="col-lg-2 control-label">Content</label>
                        <div class="col-lg-10">
                            <textarea class="form-control" rows="3" id="content" name="content"></textarea>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="reset" class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
```
**Create Post Categories**

The Post Categories allow the users to select a category for the post they are creating.

Run this command to create a new Category model and its migration:
```
php artisan make:model Category  m
```
Next, open the timestamp_create_categories_table.php and update the up method as follows:
```
public function up()
{
    Schema::create('categories', function (Blueprint $table) {
        $table->increments('id');
        $table->string('name', 255);
        $table->timestamps();
    });
}
```
**Create a Many-to-Many relation**

A post may have multiple categories.

And a category may be associated with many posts.

When in many-to many relationship, they need intermediate table to work. This table called pivot table or cross-ref table.

We will create category_post table by run this migration command.
```
php artisan make:migration create_category_post_table --create=category_post
```
Next, open the new timestamp_create_category_post_table migration file and modify the up method:  
```
public function up() {     
	Schema::create('category_post', function (Blueprint $table) {
         $table->increments('id')->unsigned();
         $table->integer('post_id')->unsigned()->index();
         $table->integer('category_id')->unsigned()->index();
         $table->timestamps();
		 $table->foreign('category_id')
		 ->references('id')->on('categories')
		 ->onUpdate('cascade')
		 ->onDelete('cascade');
		 $table->foreign('post_id')
		 ->references('id')->on('posts')
		 ->onUpdate('cascade')
		 ->onDelete('cascade');
	});
}
```

Save the changes and run the migrate command:
```
php artisan migrate
```

Great! Now open our Post model and update it to look like this:
```
<?php
namespace App;

use Illuminate\Database\Eloquent\Model;
class Post extends Model
{
    protected $guarded = ['id'];

    public function categories()
    {
        return $this->belongsToMany('App\Category')->withTimestamps();
    }
}
```
Open our Category model and update it to look like this:
```
<?php
namespace App;

use Illuminate\Database\Eloquent\Model;
class Category extends Model
{
    protected $guarded = ['id'];
    public function posts()
    {
        return $this->belongsToMany('App\Post')->withTimestamps();
    }
}
```

**Create and view categories**

Let's make a form to create categories. Open web.php, add these routes to the admin route group:
```
Route::get('categories', 'CategoriesController@index');
Route::get('categories/create', 'CategoriesController@create');
Route::post('categories/create', 'CategoriesController@store');
```
Generate a new CategoriesController by running this command:
```
php artisan make:controller Admin/CategoriesController --resource
```
Open the newly created CategoriesController and update the create action:
```
public function create()
{
    return view('backend.categories.create');
}
```

Create a new categories folder inside the backend directory.  Put a new create view in the categories directory:
```
@extends('master')
@section('title', 'Create A New Category')

@section('content')
    <div class="container col-md-8 col-md-offset-2">
        <div class="well well bs-component">

            <form class="form-horizontal" method="post">

                @foreach ($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach

                @if (session('status'))
                    <div class="alert alert-success">
                        {{ session('status') }}
                    </div>
                @endif
	 <input type="hidden" name="_token" value="{!! csrf_token() !!}">

	<fieldset>
                    <legend>Create a new category</legend>
                    <div class="form-group">
                        <label for="name" class="col-lg-2 control-label">Name</label>
                        <div class="col-lg-10">
                            <input type="text" class="form-control" id="name" name="name">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="reset" class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
```

Good job! Now open the CategoriesController again, update the store action as follows:
```
public function store(CategoryFormRequest $request)
{
    $category = new Category(array(
        'name' => $request->get('name'),
    ));
    $category->save();
    return redirect('/admin/categories/create')->with('status', 'A new category has been created!');
}
```
Tell Laravel that you want to use the CategoryFormRequest and the Category model:
```
		use App\Category;
		use App\Http\Requests\CategoryFormRequest;
```
Generate a new CategoryFormRequest file by running this:
```
		php artisan make:request CategoryFormRequest
```
Modify the authorize method  to true and the rules method to validate name as required:

To view all categories, open CategoriesController again, update the index action:
```
public function index()
{
    $categories = Category::all();
    return view('backend.categories.index', compact('categories'));
}
```
Create a new index view and place it in the categories directory:
```
@extends('master')
@section('title', 'All categories')
@section('content')

    <div class="container col-md-8 col-md-offset-2">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h2> All categories </h2>
            </div>
            @if (session('status'))
                <div class="alert alert-success">
                    {{ session('status') }}
                </div>
            @endif
			@if ($categories->isEmpty())
                <p> There is no category.</p>
            @else
                <table class="table">
                    <tbody>
                    @foreach($categories as $category)
                        <tr>
                            <td>{!! $category->name !!}</td>
                        </tr>
                    @endforeach
                    </tbody>
                </table>
            @endif
        </div>
    </div>

@endsection
```

Let's update the admin home page (dashboard) to include the category links there. Open the backend/home view: Find (at the end of the file):
```
	<a href="/admin/posts/create" class="btn btn-primary btn-raised">Create A Post</a>
    </div>
</div>
<div class="list-group-separator"></div>
```
Add below:
```
                <div class="list-group-item">
                    <div class="row-action-primary">
                        <i class="material-icons">format_list_bulleted</i>
                    </div>
                    <div class="row-content">
                        <div class="action-secondary"><i class="material-icons">format_list_bulleted</i></div>
                        <h4 class="list-group-item-heading">Manage Categories</h4>
                        <a href="/admin/categories" class="btn btn-default btn-raised">All Categories</a>
                        <a href="/admin/categories/create" class="btn btn-primary btn-raised">New Category</a>
                    </div>
                </div>
		<div class="list-group-separator"></div>
```
**Select categories when creating a post**

Now we can create a new post with categories.

Open PostsController and find:
```
class PostsController extends Controller
```
Add above:
```
use App\Category;
use App\Post;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;
```
Update the create action as follows:
```
public function create()
{
    $categories = Category::all();
    return view('backend.posts.create', compact('categories'));
}
```

Next, open the views/posts/create.blade.php view and find:
```
<div class="form-group">
    <label for="content" class="col-lg-2 control-label">Content</label>
    <div class="col-lg-10">
        <textarea class="form-control" rows="3" id="content" name="content"></textarea>
    </div>
</div>
```

Add this code below to allow users to select the categories:
```
<div class="form-group">
<label for="categories" class="col-lg-2 control-label">Categories</label>
    <div class="col-lg-10">
    <select class="form-control" id="category" name="categories[]" multiple>
            @foreach($categories as $category)
                <option value="{!! $category->id !!}">
                    {!! $category->name !!}
                </option>
            @endforeach
        </select>
    </div>
</div>
```
Now let's create the PostFormRequest first:
```
php artisan make:request PostFormRequest
```
Modify the authorize method and the rules method of the PostFormRequest to look like this:
```
public function authorize()
{
    return true;
}
```
```
public function rules()
{
    return [
        'title' => 'required',
        'content'=> 'required',
        'categories' => 'required',
    ];
}
```
Finally, open the PostsController again, and find:
```
class PostsController extends Controller
```
Add this code above to use PostFormRequest in this controller:
```
use App\Http\Requests\PostFormRequest;
```
Next, update the store action:
```
public function store(PostFormRequest $request)
{
    $user_id = Auth::user()->id;
    $post= new Post(array(
        'title' => $request->get('title'),
        'content' => $request->get('content'),
        'slug' => Str::slug($request->get('title'), '-'),
        'user_id' => $user_id
    ));

    $post->save();
    $post->categories()->sync($request->get('categories'));

    return redirect('/admin/posts/create')->with('status', 'The post has been created!');
}
```
**View and edit posts**

As a reminder, we've already defined this route in the previous section:
```
		Route::get('posts', 'PostsController@index');
```
We can update the index action of the PostsController as follows:
```
public function index()
{
    $posts = Post::all();
    return view('backend.posts.index', compact('posts'));
}
```
Next, create a new index view at backend/posts/index.blade.php:
```
@extends('master')
@section('title', 'All posts')
@section('content')

    <div class="container col-md-8 col-md-offset-2">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h2> All posts </h2>
            </div>
            @if (session('status'))
                <div class="alert alert-success">
                    {{ session('status') }}
                </div>
            @endif
            @if ($posts->isEmpty())
                <p> There is no post.</p>
            @else
                <table class="table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Slug</th>
                        <th>Created At</th>
                        <th>Updated At</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach($posts as $post)
                        <tr>
                            <td>{!! $post->id !!}</td>
                            <td>
                                <a href="#">{!! $post->title !!} </a>
                            </td>
                            <td>{!! $post->slug !!}</td>
                            <td>{!! $post->created_at !!}</td>
                            <td>{!! $post->updated_at !!}</td>
                        </tr>
                    @endforeach
                    </tbody>
                </table>
            @endif
        </div>
    </div>

@endsection
```
**Edit a post**

Let's modify the edit action to display a post edit form:
```
public function edit($id)
{
    $post = Post::whereId($id)->firstOrFail();
    $categories = Category::all();
    $selectedCategories = $post->categories->pluck('id')->toArray();
    return view('backend.posts.edit', compact('post', 'categories', 'selectedCategories'));
}
```
Create a new edit view at backend/posts/edit.blade.php:
```
@extends('master')
@section('title', 'Edit A Post')
@section('content')
    <div class="container col-md-8 col-md-offset-2">
        <div class="well well bs-component">
            <form class="form-horizontal" method="post">
                @foreach ($errors->all() as $error)
                    <p class="alert alert-danger">{{ $error }}</p>
                @endforeach
                @if (session('status'))
                    <div class="alert alert-success">
                        {{ session('status') }}
                    </div>
                @endif
                <input type="hidden" name="_token" value="{!! csrf_token() !!}">
                <fieldset>
                    <legend>Edit a post</legend>
                    <div class="form-group">
                        <label for="title" class="col-lg-2 control-label">Title</label>
                        <div class="col-lg-10">
                            <input type="text" class="form-control" id="title" placeholder="Title" name="title" value="{{ $post->title }}">
                        </div>
                    </div>
 <div class="form-group">
                        <label for="content" class="col-lg-2 control-label">Content</label>
                        <div class="col-lg-10">

<textarea class="form-control" rows="3" id="content" name="content">{!! $post->content !!}</textarea>
                        </div>
                    </div>
<div class="form-group">
                        <label for="select" class="col-lg-2 control-label">Categories</label>
                        <div class="col-lg-10">
                            <select class="form-control" id="categories" name="categories[]" multiple>
                                @foreach($categories as $category)
                                    <option value="{!! $category->id !!}"  @if(in_array($category->id, $selectedCategories))
                                            selected="selected" @endif >{!! $category->name !!}
                                    </option>
                                @endforeach
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-lg-10 col-lg-offset-2">
                            <button type="reset" class="btn btn-default">Cancel</button>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </div>
                </fieldset>
            </form>
        </div>
    </div>
@endsection
```

After creating the form, you'll need to modify the posts/index view to add links to the posts.

Find:
```
<a href="#">{!! $post->title !!} </a>
```
Edit to:
```
<a href="{!! action('Admin\PostsController@edit', $post->id) !!}">{!! $post->title !!} </a>
```

To update post, we create a new PostEditFormRequest by running this command:

```
php artisan make:request PostEditFormRequest
```

Modify the authorize method and the rules method to look like this:
```
public function authorize()
{
    return true;
}
```

```
public function rules()
{
    return [
        'title' => 'required',
        'content'=> 'required',
        'categories' => 'required',
    ];
}
```

Open PostsController and find:
```
class PostsController extends Controller
```
Add above:

```
use App\Http\Requests\PostEditFormRequest;
```
Finally, update the update method to save the changes to our database:
```
public function update($id, PostEditFormRequest $request)
{
    $post = Post::whereId($id)->firstOrFail();
    $post->title = $request->get('title');
    $post->content = $request->get('content');
    $post->slug = Str::slug($request->get('title'), '-');

    $post->save();
    $post->categories()->sync($request->get('categories'));

    return redirect(action('Admin\PostsController@edit', $post->id))->with('status', 'The post has been updated!');
}
```

**Display all blog posts**

In this section, we will create a blog page that lists all blog posts. This page is public. Everyone can access it and read the posts.

Let's register a blog route by adding the following code to web.php:
```
Route::get('/blog', 'BlogController@index');
```
We would need to create the BlogController:
```
php artisan make:controller BlogController --resource
```
Go to BlogController, Insert the following code into it:

Find:
```
class BlogController extends Controller
```

Tell Laravel that you want to use the Post model in this controller. Add above:
```
use App\Post;
```

Now, update the index action:
```
public function index()
{
    $posts = Post::all();
    return view('blog.index', compact('posts'));
}
```

Create a new index view at views/blog directory. The following are the contents of the views/blog/index.blade.php file:
```
@extends('master')
@section('title', 'Blog')
@section('content')

    <div class="container col-md-8 col-md-offset-2">

        @if (session('status'))
            <div class="alert alert-success">
                {{ session('status') }}
            </div>
        @endif

        @if ($posts->isEmpty())
            <p> There is no post.</p>
		@else
            @foreach ($posts as $post)
                <div class="panel panel-default">
                    <div class="panel-heading">{!! $post->title !!}</div>
                    <div class="panel-body">
                        {!! mb_substr($post->content,0,500) !!}
                    </div>
                </div>
            @endforeach
        @endif
    </div>

@endsection
```

We should add a blog link to our navigation bar to access the blog page faster. Open shared/navbar.blade.php and find:
```
<li><a href="/about">About</a></li>
```

Add above it:
```
<li><a href="/blog">Blog</a></li>
```

**Display a single blog post**

When we click on the post's title, we should see the full post.

Open web.php, register this route:
```
Route::get('/blog/{slug?}', 'BlogController@show');
```

Before updating the show method, let's think about how we can implement the blog post comment feature. 

Using Polymorphic Relations

http://laravel.com/docs/master/eloquent-relationships#many-to-many-polymorphic-relations

To build this relationship, our comments table must have two columns: post_id and post_type. The post_id column contains the ID of the tickets or the posts, 
while the post_type contains the class name of the owning model (App\Ticket or App\Post).

Currently, the comments table has the post_id column but it doesn't have the post_type column yet. Let's create a migration to add the column into our comments table:
```
php artisan make:migration add_post_type_to_comments_table --table=comments
```

Open the file and modify it to look like this:
```
public function up()
{
    if(Schema::hasColumn('comments', 'post_type')) {

    } else {
        Schema::table('comments', function (Blueprint $table) {
            $table->string('post_type')->nullable();
        });
    }
}
```
```

public function down()
{
    Schema::table('comments', function (Blueprint $table) {
        $table->dropColumn('post_type');
    });
}
```
And the run : 
```
	php artisan migrate
```

It's time to build the Polymorphic relationship. Open the Comment model, update it as follows:
```
<?php
namespace App;

use Illuminate\Database\Eloquent\Model;
class Comment extends Model
{
    protected $guarded = ['id'];
    public function post()
    {
        return $this->morphTo();
    }
}
```

Open the Ticket model, update the comments() method to:
```
<?php
namespace App;

use Illuminate\Database\Eloquent\Model;
class Ticket extends Model
{
    protected $guarded = ['id'];

    public function comments()
    {
        return $this->morphMany('App\Comment', 'post');
    }
}
```

Open the Post model, update it as follows:
```
<?php
namespace App;

use Illuminate\Database\Eloquent\Model;
class Post extends Model
{
    protected $guarded = ['id'];
    public function categories()
    {
        return $this->belongsToMany('App\Category')->withTimestamps();
    }

    public function comments()
    {
        return $this->morphMany('App\Comment', 'post');
    }
}
```

Done! You've defined Polymorphic relations.

Now, open BlogController and update the show method:
```
public function show($slug)
{
    $post = Post::whereSlug($slug)->firstOrFail();
    $comments = $post->comments()->get();
    return view('blog.show', compact('post', 'comments'));
}
```

Here is the views/blog/show.blade.php view (create it first):
```
@extends('master')
@section('title', 'View a post')
@section('content')
    <div class="container col-md-8 col-md-offset-2">
            <div class="well well bs-component">
                <div class="content">
                    <h2 class="header">{!! $post->title !!}</h2>
                    <p> {!! $post->content !!} </p>
                </div>
                <div class="clearfix"></div>
            </div>
            @foreach($comments as $comment)
                <div class="well well bs-component">
                    <div class="content">
                        {!! $comment->content !!}
                    </div>
                </div>
            @endforeach
            <div class="well well bs-component">
                <form class="form-horizontal" method="post" action="/comment">
                    @foreach($errors->all() as $error)
                        <p class="alert alert-danger">{{ $error }}</p>
                    @endforeach   
					@if(session('status'))
                        <div class="alert alert-success">
                            {{ session('status') }}
						</div>
                    @endif
                    <input type="hidden" name="_token" value="{!! csrf_token() !!}">
                    <input type="hidden" name="post_id" value="{!! $post->id !!}">
                    <input type="hidden" name="post_type" value="App\Post">
                    <fieldset>
                        <legend>Comment</legend>
                        <div class="form-group">
                            <div class="col-lg-12">
                                <textarea class="form-control" rows="3" id="content" name="content"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-lg-10 col-lg-offset-2">
                                <button type="reset" class="btn btn-default">Cancel</button>
                                <button type="submit" class="btn btn-primary">Post</button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>
    </div>
@endsection
```

Notice that we've added a new hidden field called post_type. Because this is the post's comment, the value of the field is: "App\Post" (class name).

Open CommentsController and find:
```
$comment = new Comment(array(
    'post_id' => $request->get('post_id'),
    'content' => $request->get('content'),
));
```

Add post_type to save its value into the database:
```
    $comment = new Comment(array(
        'post_id' => $request->get('post_id'),
        'content' => $request->get('content'),
        'post_type' => $request->get('post_type')
    ));
```
Finally, open the ticket/show view and find:
```
 <input type="hidden" name="post_id" value="{!! $ticket->id !!}">
```

Add below:
```
<input type="hidden" name="post_type" value="App\Ticket">
```

One more thing to do, open the blog/index view and find:
```
<div class="panel-heading">{!! $post->title !!}</div>
```

Modify to:
```
<div class="panel-heading"><a href="{!! action('BlogController@show', $post->slug) !!}">{!! $post->title !!}</a></div>
```
**Seeding our database**

Instead of creating test data manually, we can use Laravel's Seeder class to populating our database. In this section, we will learn how to use Seeder by creating sample users for our application.

To create a seeder, run this command:
```
php artisan make:seeder UserTableSeeder
```

This will create a class called UserTableSeeder, which is placed in database/seeds directory.

Update the run() method as follows:
```
public function run()
{
    DB::table('users')->insert([
     [
        'name' => 'Nathan',
        'email' => str_random(12).'@email.com',
        'password' => bcrypt('yourPassword'),
         'created_at'       => new DateTime,
         'updated_at'       => new DateTime,
    ],
     [
            'name' => 'David',
            'email' => str_random(12).'@email.com',
            'password' => bcrypt('yourPassword'),
            'created_at'       => new DateTime,
            'updated_at'       => new DateTime,

        ],
        [
            'name' => 'Lisa',
            'email' => str_random(12).'@email.com',
            'password' => bcrypt('yourPassword'),
            'created_at'       => new DateTime,
            'updated_at'       => new DateTime,
        ],
    ]);
}
```

After writing the seeder class, open database/seeds/DatabaseSeeder.php.

Modify run method to following
```
public function run()
{
     $this->call(UserTableSeeder::class);
}
```
To seed data, run this Artisan command:
```
php artisan db:seed
```

**Localization**

You can easily translate strings to multiple languages using Laravel localization feature.

All language files are stored in the resources/lang directory.

By default, there is an en (English) directory, which contains English strings. If you want to support other languages, create a new directory at the same level as the en directory. Please note that all language directories should be named using ISO 639-1 Code.

Read more about ISO 639-1 Code here:

http://www.loc.gov/standards/iso639-2/php/code_list.php


You can change the default language by go to config/app.php configuration file
```
			'locale' => 'en',
```

Go to resources/lang/en directory, create a new file called main.php, which looks like this:
```
<?php
return [

    'subtitle' => 'Fastest way to learn Laravel',

];
```

Next, open the home view (views/home.blade.php file) and find:
```
<h3 class="text-center margin-top-100 editContent">Building Practical Applications</h3>
```
Change to:
```
<h3 class="text-center margin-top-100 editContent">{!! trans('main.subtitle') !!}</h3>
```

**Summary**

Congratulations! You've built a complete blog application!

Our application is not perfect yet, but you may use it as a starter template and apply some concepts that you've known to build a larger application.

Towards the end of this chapter, let's review what we have learned:
- You've known how to **authenticate** users and add **login throttling** to your app.
- You now understand more about **routes** and **route group**.
- Using **Middleware**, you can handle requests/responses effectively.
- Many Laravel applications are using **laravel-permission**, it's one of the best packages to manage roles and permissions. We only use the "roles" feature in this book. Try to create some permissions to secure your apps better.
- Understanding **Many-to-Many Relations** and **Polymorphic Relations** is hard at first, but you'll gain many benefits later.
- Now you can be able to **seed your database**! Seeding is easy. Right?
- The Laravel **localization** feature is simple, but it's very helpful and powerful. Try to use it in all your applications to manage all the strings.

